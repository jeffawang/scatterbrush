<!DOCTYPE HTML>
<style type="text/css">
svg.main {
  border: 1px solid #aaa;
}
.brush .extent {
  stroke: #000;
  fill-opacity: 0.125;
  shape-rendering: crispEdges;
}
.point {
  fill: #999;
  stroke: #fff;
}
.point.selected {
  fill: red;
  fill-opacity: 1;
  stroke: brown;
}
</style>
<script type="text/javascript" src="/js/d3.min.js"/></script>
<body>
<script type="text/javascript">
var width = 600,
  height = 600;
var margins = {
  "top": 10,
  "bottom": 10,
  "left": 10,
  "right": 10 };
var margined = {
  "left": margins['left'],
  "top": margins['top'],
  "right": width - margins['right'],
  "bottom": height - margins['bottom'],
  "width": width - margins['right']-margins['left'],
  "height": height - margins['bottom']-margins['top']
};
var defaultExtent = [[100,100],[300,300]];
var svg = d3.select("body")
  .append("svg")
    .attr("class", "main")
    .attr("width", width)
    .attr("height", height)
  .append("g")
    .attr("class", "main");
var x = d3.scale.identity().domain([margined['left'], margined['right']]);
var y = d3.scale.identity().domain([margined['top'], margined['bottom']]);
var brush = d3.svg.brush()
  .x(x)
  .y(y)
  .extent(defaultExtent)
  .on("brush", brushed)
  .on("brushend", brushended)
var data = d3.range(1000).map(function() {
  return [margined["left"] + Math.random() * margined["width"],
          margined["top"] + Math.random() * margined["height"]]; });
var quadtree = d3.geom.quadtree()
  .extent([[-1,1], [width + 1, height + 1]])
  (data);
var point = svg.selectAll(".point")
  .data(data)
  .enter().append("circle")
    .attr("class", "point")
    .attr("cx", function(d) { return d[0] })
    .attr("cy", function(d) { return d[1] })
    .attr("r", 4);

svg.append("g")
  .attr("class", "brush")
  .call(brush)
  .call(brush.event)

function brushstarted() {
  console.log("started brushing")
}
function brushed() {
  var extent = brush.extent();
  point.each(function(d) { d.selected = false });
  search(quadtree, extent[0][0], extent[0][1], extent[1][0], extent[1][1]);
  point.classed("selected", function(d) { return d.selected });
}
function brushended(e, i) {
  console.log("brush ended")
}

function search(quadtree, x0, y0, x3, y3) {
  quadtree.visit(function(node, x1, y1, x2, y2) {
    var p = node.point;
    if (p) p.selected = (p[0] >= x0) && (p[0] < x3) && (p[1] >= y0) && (p[1] < y3);
    return x1 >= x3 || y1 >= y3 || x2 < x0 || y2 < y0;
  });
}

</script>
